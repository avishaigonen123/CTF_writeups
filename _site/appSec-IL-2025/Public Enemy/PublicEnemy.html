<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Public Enemy | Avishai’s CTF Writeups</title>
<meta name="generator" content="Jekyll v3.10.0" />
<meta property="og:title" content="Public Enemy" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="…" />
<meta property="og:description" content="…" />
<link rel="canonical" href="http://localhost:4000/appSec-IL-2025/Public%20Enemy/PublicEnemy.html" />
<meta property="og:url" content="http://localhost:4000/appSec-IL-2025/Public%20Enemy/PublicEnemy.html" />
<meta property="og:site_name" content="Avishai’s CTF Writeups" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Public Enemy" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"…","headline":"Public Enemy","url":"http://localhost:4000/appSec-IL-2025/Public%20Enemy/PublicEnemy.html"}</script>
<!-- End Jekyll SEO tag -->

    <link rel="stylesheet" href="/assets/css/style.css?v=885199f883f5b847967c84d0262eab1578eb3466">
    <script src="https://code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>
    <script src="/assets/js/respond.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <!--[if lt IE 8]>
    <link rel="stylesheet" href="/assets/css/ie.css">
    <![endif]-->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <link rel="shortcut icon" type="image/x-icon" href="/CTF_writeups/favicon.ico">
  </head>
  <body>
      <div id="header">
        <nav>
          <ul>
            <li class="fork"><a href="https://github.com/avishaigonen123/CTF_writeups">View On GitHub</a></li>
            
          </ul>
        </nav>
      </div><!-- end header -->

    <div class="wrapper">

      <section>
        <div id="title">
          <h1>Avishai's CTF Writeups</h1>
          <p>...</p>
          <hr>
          <span class="credits left">Project maintained by <a href="https://github.com/avishaigonen123">avishaigonen123</a></span>
          <span class="credits right">Hosted on GitHub Pages &mdash; Theme by <a href="https://twitter.com/mattgraham">mattgraham</a></span>
        </div>

        <h1 id="public-enemy">Public Enemy</h1>

<ul>
  <li><strong>Category:</strong> Web</li>
  <li><strong>Points:</strong> 500</li>
  <li><strong>Solved by:</strong> JCTF Team</li>
</ul>

<hr />

<h2 id="description">Description</h2>

<p><img src="/appSec-IL-2025/Public%20Enemy/Challenge-info.gif" alt="problem description" /></p>

<p>The challenge lets users log in and uses JWT to maintain session cookies. It’s vulnerable to an algorithm confusion attack mixed with prototype pollution.</p>

<hr />

<h2 id="solution">Solution</h2>

<p>First, we log in as guest with <code class="language-plaintext highlighter-rouge">guest</code> as username and password. This is the JWT token we got: 
<img src="/appSec-IL-2025/Public%20Enemy/JWT-token.png" alt="jwt token" /></p>

<p>As we can see, it holds our username and also the <code class="language-plaintext highlighter-rouge">isAdmin</code> field. From the source code, in the file <code class="language-plaintext highlighter-rouge">index.js</code>, we need to somehow be the admin in order to view the <code class="language-plaintext highlighter-rouge">FLAG</code>.</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">,</span> <span class="nx">ensureAuth</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="dl">"</span><span class="s2">index.ejs</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span>
        <span class="na">username</span><span class="p">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">username</span> <span class="o">||</span> <span class="dl">"</span><span class="s2">guest</span><span class="dl">"</span><span class="p">,</span>
        <span class="na">isAdmin</span><span class="p">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">isAdmin</span> <span class="o">||</span> <span class="kc">false</span><span class="p">,</span>
        <span class="na">flag</span><span class="p">:</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">isAdmin</span><span class="p">)</span> <span class="p">?</span> <span class="nx">FLAG</span> <span class="p">:</span> <span class="kc">null</span>
    <span class="p">});</span>
<span class="p">});</span>
</code></pre></div></div>
<!-- ![get the flag](/appSec-IL-2025/Public%20Enemy/Flag-part-code.png) -->

<p>If we observe the code, we can see it accepts 3 algorithms: <code class="language-plaintext highlighter-rouge">HMAC</code>, which is symmetric, and <code class="language-plaintext highlighter-rouge">RSA</code> and <code class="language-plaintext highlighter-rouge">ESA</code>, which are asymmetric.</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">verified</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="nx">algorithm</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">hmac</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span> 
<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">algorithm</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">rsa</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span> 
<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">algorithm</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">esa</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span> <span class="p">....</span> <span class="p">}</span> 
<span class="k">else</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="dl">"</span><span class="s2">algorithm is unsupported</span><span class="dl">"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>
<!-- ![verify function](/appSec-IL-2025/Public%20Enemy/Verify-code.png) -->

<p>The <code class="language-plaintext highlighter-rouge">sign</code> function and the <code class="language-plaintext highlighter-rouge">verify</code> function are well implemented, so trying to push <code class="language-plaintext highlighter-rouge">none</code> as the algorithm type in the JWT token won’t work.</p>

<h2 id="flaw-1">Flaw 1</h2>
<p>However, we can detect a flaw here: in the supported algorithms in file <code class="language-plaintext highlighter-rouge">index.js</code> it mentions <code class="language-plaintext highlighter-rouge">PS256</code>, while in <code class="language-plaintext highlighter-rouge">jwt.js</code> it mentions <code class="language-plaintext highlighter-rouge">HS256</code>, and not <code class="language-plaintext highlighter-rouge">PS256</code>.</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">alg</span> <span class="o">=</span> <span class="nx">jwt</span><span class="p">.</span><span class="nx">supported_algorithms</span><span class="p">;</span>
<span class="kd">const</span> <span class="nx">payload</span> <span class="o">=</span> <span class="nx">jwt</span><span class="p">.</span><span class="nx">verify</span><span class="p">(</span>
    <span class="nx">token</span><span class="p">,</span> <span class="nx">PUBLIC_KEY</span><span class="p">,</span> <span class="p">{</span>
        <span class="dl">"</span><span class="s2">algorithms</span><span class="dl">"</span><span class="p">:</span> <span class="p">[</span><span class="nx">alg</span><span class="p">.</span><span class="nx">RS256</span><span class="p">,</span> <span class="nx">alg</span><span class="p">.</span><span class="nx">ES256</span><span class="p">,</span> <span class="nx">alg</span><span class="p">.</span><span class="nx">PS256</span><span class="p">],</span>
    <span class="p">}</span>
<span class="p">);</span>
</code></pre></div></div>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">this</span><span class="p">.</span><span class="nx">algorithms</span> <span class="o">=</span> <span class="p">{</span>
            <span class="na">HS256</span><span class="p">:</span> <span class="p">{</span><span class="na">hash</span><span class="p">:</span> <span class="dl">'</span><span class="s1">sha256</span><span class="dl">'</span><span class="p">,</span> <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">hmac</span><span class="dl">'</span><span class="p">},</span>
            <span class="na">HS384</span><span class="p">:</span> <span class="p">{</span><span class="na">hash</span><span class="p">:</span> <span class="dl">'</span><span class="s1">sha384</span><span class="dl">'</span><span class="p">,</span> <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">hmac</span><span class="dl">'</span><span class="p">},</span>
            <span class="na">HS512</span><span class="p">:</span> <span class="p">{</span><span class="na">hash</span><span class="p">:</span> <span class="dl">'</span><span class="s1">sha512</span><span class="dl">'</span><span class="p">,</span> <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">hmac</span><span class="dl">'</span><span class="p">},</span>
            <span class="na">RS256</span><span class="p">:</span> <span class="p">{</span><span class="na">hash</span><span class="p">:</span> <span class="dl">'</span><span class="s1">RSA-SHA256</span><span class="dl">'</span><span class="p">,</span> <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">rsa</span><span class="dl">'</span><span class="p">},</span>
            <span class="na">RS384</span><span class="p">:</span> <span class="p">{</span><span class="na">hash</span><span class="p">:</span> <span class="dl">'</span><span class="s1">RSA-SHA384</span><span class="dl">'</span><span class="p">,</span> <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">rsa</span><span class="dl">'</span><span class="p">},</span>
            <span class="na">RS512</span><span class="p">:</span> <span class="p">{</span><span class="na">hash</span><span class="p">:</span> <span class="dl">'</span><span class="s1">RSA-SHA512</span><span class="dl">'</span><span class="p">,</span> <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">rsa</span><span class="dl">'</span><span class="p">},</span>
            <span class="na">ES256</span><span class="p">:</span> <span class="p">{</span><span class="na">hash</span><span class="p">:</span> <span class="dl">'</span><span class="s1">sha256</span><span class="dl">'</span><span class="p">,</span> <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">esa</span><span class="dl">'</span><span class="p">},</span>
            <span class="na">ES384</span><span class="p">:</span> <span class="p">{</span><span class="na">hash</span><span class="p">:</span> <span class="dl">'</span><span class="s1">sha384</span><span class="dl">'</span><span class="p">,</span> <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">esa</span><span class="dl">'</span><span class="p">},</span>
            <span class="na">ES512</span><span class="p">:</span> <span class="p">{</span><span class="na">hash</span><span class="p">:</span> <span class="dl">'</span><span class="s1">sha512</span><span class="dl">'</span><span class="p">,</span> <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">esa</span><span class="dl">'</span><span class="p">}</span>
        <span class="p">}</span>
</code></pre></div></div>
<!-- ![the vuln typo](/appSec-IL-2025/Public%20Enemy/Vuln-typo.png) -->
<!-- ![allowed algorithms](/appSec-IL-2025/Public%20Enemy/Allowd-algorithms.png) -->

<p>So, the algorithm list that is being passed to the <code class="language-plaintext highlighter-rouge">verify</code> function contains <code class="language-plaintext highlighter-rouge">undefined</code>. This might help us.</p>

<h2 id="flaw-2">Flaw 2</h2>
<p>In the <code class="language-plaintext highlighter-rouge">verify</code> function, we can see on line 130 it calls <code class="language-plaintext highlighter-rouge">Object.assign</code> on the <code class="language-plaintext highlighter-rouge">JWT header</code>, since the JWT header is user-controlled and not properly filtered, an attacker can supply malicious properties (like <code class="language-plaintext highlighter-rouge">__proto__</code>) in the header, enabling prototype pollution.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">header</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">decodeBase64Url</span><span class="p">(</span><span class="nx">headerEncoded</span><span class="p">).</span><span class="nx">toString</span><span class="p">());</span>

<span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">algorithms</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">options</span><span class="p">.</span><span class="nx">algorithms</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="nx">header</span><span class="p">.</span><span class="nx">alg</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="nb">Error</span><span class="p">(</span><span class="dl">"</span><span class="s2">algorithm is not allowed</span><span class="dl">"</span><span class="p">);</span>
<span class="p">}</span>

<span class="nx">header</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">assign</span><span class="p">({},</span> <span class="nx">header</span><span class="p">);</span>
<span class="nx">header</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">freeze</span><span class="p">(</span><span class="nx">header</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">algorithm</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">algorithms</span><span class="p">[</span><span class="nx">header</span><span class="p">.</span><span class="nx">alg</span><span class="p">];</span>
</code></pre></div></div>
<!-- ![prototype pollution](/appSec-IL-2025/Public%20Enemy/Prototype-pollution.png) -->
<p>In addition, it passes the IF check if we don’t supply any <code class="language-plaintext highlighter-rouge">alg</code> inside the header of the JWT token, because as we already saw in <em>Flaw 1</em>, <code class="language-plaintext highlighter-rouge">undefined</code> is found in this list.</p>

<p>So, we can use this flaw to inject our own header.alg, by supplying this as the header for our JWT token.</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"typ"</span><span class="p">:</span><span class="w"> </span><span class="s2">"JWT"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"__proto__"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"alg"</span><span class="p">:</span><span class="w"> </span><span class="s2">"HS256"</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h2 id="flaw-3">Flaw 3</h2>

<p>All we need for our algorithm confusion attack is to obtain the <code class="language-plaintext highlighter-rouge">public key</code>. We use the tool <a href="https://github.com/FlorianPicca/JWT-Key-Recovery">JWT-Key-Recovery</a> from GitHub, and extract the <code class="language-plaintext highlighter-rouge">public key</code> by supplying 2 JWT tokens.
 <img src="/appSec-IL-2025/Public%20Enemy/Extract-public-key.png" alt="Extract public key" /></p>

<hr />

<p>## Attack</p>

<p>We need to change the header and the payload. In the header, we use <em>Flaw 1</em> and <em>Flaw 2</em> in order to use <code class="language-plaintext highlighter-rouge">HS256</code>, which is a symmetric algorithm, and in the payload we set the <code class="language-plaintext highlighter-rouge">isAdmin</code> flag to true.</p>

<p><img src="/appSec-IL-2025/Public%20Enemy/Final-attack.png" alt="Final attack" /></p>

<p>All that’s left is to sign this token with the <code class="language-plaintext highlighter-rouge">public key</code> we obtained in <em>Flaw 3</em>. Notice it might be frustrating—the format of the key, new lines might jump. 
I changed the source code of the <code class="language-plaintext highlighter-rouge">recover.py</code> and printed the <code class="language-plaintext highlighter-rouge">PEM key</code> already base64 encoded.</p>

<blockquote>
  <p>Alternatively, you can use <code class="language-plaintext highlighter-rouge">openssl</code> to convert the PEM public key to the required format. For example:</p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openssl ec -pubin -in out.pem | base64 -w 0
</code></pre></div>  </div>
  <p>(Make sure to adjust the command and file names as needed for your key type.)</p>
</blockquote>

<p><img src="/appSec-IL-2025/Public%20Enemy/Final-image.png" alt="FLAG-picture" /></p>

<p>The flag is <code class="language-plaintext highlighter-rouge">AppSec-IL{i_am_confusion}</code></p>


      </section>

    </div>
  </body>
</html>
